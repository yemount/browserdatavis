define("lib/xhr",["jquery","nbd/trait/promise"],function(e,t){"use strict";return function(){var n=new t,i=e.ajax.apply(e,arguments);return n.resolve(i),n.thenable()}}),define("be/Controller/Dialog",["nbd/Controller/Entity","nbd/util/media"],function(e,t){"use strict";var n=e.extend({init:function(){this._super.apply(this,arguments),this.mediaView=this.mediaView.bind(this),t.on("all",this.mediaView)},destroy:function(){t.off(null,this.mediaView),this._view&&this._view.destroy(),this._model.destroy()},_initView:function(e,n){var i,s=t.getState();i="function"==typeof e?e:s.map(function(t){return e[t]}).filter(function(e){return!!e})[0],"function"==typeof i&&(this._view=this._view=new i(n),this._view._controller=this._view._controller=this)},render:function(){return this._view&&this._view.render.apply(this._view,arguments)},mediaView:function(e,t){var n=this.constructor.VIEW_CLASS[e];n&&t&&this.requestView(n)},switchView:function(e){var t=this._view;return this._initView(e,this._model),t&&t.destroy()}});return n}),define("be/Controller/Dialog/Roulette",["jquery","be/Controller/Dialog","nbd/util/async"],function(e,t,n){"use strict";var i=t.extend({$context:null,setContext:function(e){this.$context&&this.$context.off("click"),this.$context=e.on("click",function(e){e.isDefaultPrevented()||e.originalEvent.data===this._view||this.toggle(e.delegateTarget)}.bind(this))},render:function(e){var t=this._view.render(document.body);return this._view.position(e),t},toggle:function(e){this._view.$view&&this._view.$view.length?(this._view.toggle(),this._view.position(e)):(this.render(e||this.$context),n(this._view.show.bind(this._view)))}});return i}),define("require/hgn!templates/dialog",["hogan"],function(e){function t(){return n.render.apply(n,arguments)}var n=new e.Template({code:function(e,t,n){var i=this;return i.b(n=n||""),i.b('<div class="popup '),i.b(i.v(i.f("dialogType",e,t,0))),i.s(i.f("classes",e,t,1),e,t,0,44,50,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b(" "),n.b(n.v(n.d(".",e,t,0)))}),e.pop()),i.s(i.f("buttons",e,t,1),e,t,1,0,0,"")||i.b(" no-buttons"),i.s(i.f("title",e,t,1),e,t,1,0,0,"")||i.b(" no-title"),i.s(i.f("fullBleed",e,t,1),e,t,0,140,151,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b(" full-bleed")}),e.pop()),i.b('">'),i.b("\n"+n),i.b('  <div class="popup-inner-wrap">'),i.b("\n"),i.b("\n"+n),i.s(i.f("toolbar",e,t,1),e,t,0,218,647,"{{ }}")&&(i.rs(e,t,function(e,t,i){i.b('    <div class="'),i.s(i.f("layover",e,t,1),e,t,0,247,254,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b("toolbar")}),e.pop()),i.s(i.f("layover",e,t,1),e,t,1,0,0,"")||i.b("popup-header"),i.b('">'),i.b("\n"+n),i.b('      <div class="header">'),i.b(i.t(i.f("title",e,t,0))),i.b("</div>"),i.b("\n"+n),i.s(i.f("hideClose",e,t,1),e,t,1,0,0,"")||(i.b('        <a class="header-action close right js-close'),i.s(i.f("layover",e,t,1),e,t,1,0,0,"")||i.b(" popup-close"),i.b('">'),i.b("\n"+n),i.b('          <span class="nav-icon-close nav-icon"></span>'),i.b("\n"+n),i.b("        </a>"),i.b("\n"+n)),i.s(i.f("layover",e,t,1),e,t,0,569,619,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.s(n.f("button",e,t,1),e,t,0,589,601,"{{ }}")&&(n.rs(e,t,function(e,t,n){n.b(n.rp("<button0",e,t,""))}),e.pop())}),e.pop()),i.b("    </div>"),i.b("\n"+n)}),e.pop()),i.b("\n"+n),i.b('    <div class="popup-content'),i.s(i.f("toolbar",e,t,1),e,t,0,702,714,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b(" has-toolbar")}),e.pop()),i.b('">'),i.b("\n"+n),i.b(i.rp("<content1",e,t,"      ")),i.s(i.f("layover",e,t,1),e,t,1,0,0,"")||(i.b("    </div>"),i.b("\n"+n)),i.b("\n"+n),i.b('      <div class="popup-buttons'),i.s(i.f("buttons",e,t,1),e,t,1,0,0,"")||i.b(" hide"),i.b('">'),i.b("\n"+n),i.s(i.f("buttons",e,t,1),e,t,0,878,890,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b(n.rp("<button2",e,t,""))}),e.pop()),i.b("      </div>"),i.b("\n"),i.b("\n"+n),i.s(i.f("layover",e,t,1),e,t,0,933,949,"{{ }}")&&(i.rs(e,t,function(e,t,i){i.b("    </div>"),i.b("\n"+n)}),e.pop()),i.b("\n"+n),i.b("  </div> <!-- /.popup-inner -->"),i.b("\n"),i.b("\n"+n),i.b("</div>"),i.b("\n"),i.b("\n"+n),i.s(i.f("blocking",e,t,1),e,t,0,1017,1051,"{{ }}")&&(i.rs(e,t,function(e,t,i){i.b('<div class="blocking-div"></div>'),i.b("\n"+n)}),e.pop()),i.fl()},partials:{"<button0":{name:"button",partials:{},subs:{}},"<content1":{name:"content",partials:{},subs:{}},"<button2":{name:"button",partials:{},subs:{}}},subs:{}},"",e);return t.template=n,t}),define("require/hgn!templates/button",["hogan"],function(e){function t(){return n.render.apply(n,arguments)}var n=new e.Template({code:function(e,t,n){var i=this;return i.b(n=n||""),i.b('  <div class="form-item form-item-a'),i.s(i.f("containerClasses",e,t,1),e,t,0,56,62,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b(" "),n.b(n.v(n.d(".",e,t,0)))}),e.pop()),i.b('">'),i.b("\n"+n),i.b('    <a class="form-button'),i.s(i.f("classes",e,t,1),e,t,0,123,129,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b(" "),n.b(n.v(n.d(".",e,t,0)))}),e.pop()),i.s(i.f("classes",e,t,1),e,t,1,0,0,"")||i.b(" form-button-default"),i.b('"'),i.b("\n"+n),i.b("      "),i.s(i.f("href",e,t,1),e,t,0,202,218,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b(' href="'),n.b(n.v(n.f("href",e,t,0))),n.b('"')}),e.pop()),i.b(' unselectable="on"'),i.b("\n"+n),i.b("      tabindex="),i.s(i.f("tabindex",e,t,1),e,t,0,274,288,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b('"'),n.b(n.v(n.f("tabindex",e,t,0))),n.b('"')}),e.pop()),i.b("\n"+n),i.b("      "),i.s(i.f("tabindex",e,t,1),e,t,1,0,0,"")||i.b('"0"'),i.b(">"),i.b(i.v(i.f("label",e,t,0))),i.b("</a>"),i.b("\n"+n),i.b("  </div>"),i.b("\n"),i.fl()},partials:{},subs:{}},"",e);return t.template=n,t}),define("be/View/Dialog",["jquery","nbd/View/Entity","nbd/util/extend","hgn!templates/dialog","hgn!templates/button"],function(e,t,n,i,s){"use strict";var o=t.extend({mustache:{},template:function(t){return e(i(t,n({content:this.mustache.template,button:s.template},this.partials)))},rendered:function(){this.$view.on("click",".js-close, .close, .form-button-close, .form-button-cancel",this.hide.bind(this)).find(".form-button-disabled").on("click",!1)},position:function(){},show:function(){return this.trigger("show",this.$view)},hide:function(){return this.trigger("hide",this.$view)},toggle:function(){var e=this.$view.is(":visible");return this[e?"hide":"show"]()}});return o}),define("be/View/Dialog/Menu",["jquery","be/View/Dialog","nbd/util/async","jquery/ui/position"],function(e,t,n){"use strict";var i=t.extend({init:function(){this._super.apply(this,arguments),this.dismiss=function(e){e.originalEvent.data!==this&&(this.hide(),e.preventDefault())}.bind(this)},destroy:function(){this._unbind(),this._super.apply(this,arguments)},template:function(t){return this._super(e.extend({dialogType:"menu",blocking:!1,hide_toolbar:!0},t))},rendered:function(){this._super();var e=this;this.$view.on("click touchend",function(t){t.originalEvent.data=e})},_bind:function(){e("html").on("click touchend",this.dismiss)},_unbind:function(){e("html").off("click touchend",this.dismiss)},position:function(t,n){if(this.$view){t&&(this._lastContext=t);var i={my:"left top",at:"left bottom+10",of:this._lastContext,collision:"flipfit"};this.$view.position(e.extend(i,n))}},show:function(){return this.$view?(n(this._bind.bind(this)),this.$view.addClass("shown"),this._super()):void 0},hide:function(){return this.$view?(this._unbind(),this.$view.removeClass("shown"),this._super()):void 0},toggle:function(){return this[this.$view.hasClass("shown")?"hide":"show"]()}});return i}),define("be/spinner",["jquery","vendor/spin"],function(e,t){"use strict";var n={lines:30,length:0,width:2,radius:9,corners:0,speed:2,trail:100,hwaccel:!0,className:"spinner",zIndex:2e9,top:"19px",left:"20px",opacity:"0"};return{init:function(t){var n=e(".js-spin",t);return n.length||(n=this._generate()),n.toArray().map(this.create),n},show:function(){this._$default||this._generate(),this._$default.appendTo(document.body)},hide:function(){this._$default&&this._$default.detach()},_generate:function(){return this._$default=e("<div>",{"class":"js-spin be-spinner"}),this.create(this._$default[0]),this._$default},create:function(i,s){var o=new t(e.extend({},n,s));return i&&o.spin(i),o}}}),define("inbox/lib/byLine",[],function(){"use strict";function e(e,t){return e.length<3?e.join(t):e[0]+t+(e.length-1)+" others"}return e}),define("inbox/Model/Message",["nbd/Model","nbd/util/extend","inbox/lib/byLine"],function(e,t,n){"use strict";function i(e){var t=[];return e&&(t=e.map(function(e){return{image:e.images&&e.images[o]||"",name:e.display_name,url:e.url,id:e.id}})),t}var s,o=115;return s=e.extend({init:function(e){this._super(this.transform(e))},transform:function(e){var s=i(e.recipients),o=+e.unread_count||0;return t(e,{byLine:n(s.map(function(e){return e.name})," and "),message:e.last_message_part,recipients:s,unread:!!o,unreadCount:o})}})}),define("require/hgn!templates/html",["hogan"],function(e){function t(){return n.render.apply(n,arguments)}var n=new e.Template({code:function(e,t,n){var i=this;return i.b(n=n||""),i.b(i.t(i.f("html",e,t,0))),i.b("\n"),i.fl()},partials:{},subs:{}},"",e);return t.template=n,t}),define("require/hgn!templates/inbox/dialog/main",["hogan"],function(e){function t(){return n.render.apply(n,arguments)}var n=new e.Template({code:function(e,t,n){var i=this;return i.b(n=n||""),i.b('<div class="bell-section activity-container-wrap">'),i.b("\n"+n),i.b('  <h2 class="bell-title notifications-title hide-phone sticky">'),i.b("\n"+n),i.b("    Your Messages"),i.b("\n"+n),i.b('    <span class="js-inbox-chrome bell-inbox-controls">'),i.b("\n"+n),i.b('      <a href="'),i.b(i.v(i.f("composeUrl",e,t,0))),i.b('" class="bell-inbox-new-message">+ New Message</a>'),i.b("\n"+n),i.b('      <a href="'),i.b(i.v(i.f("indexUrl",e,t,0))),i.b('" class="bell-inbox-view-all">View All</a>'),i.b("\n"+n),i.b("    </span>"),i.b("\n"+n),i.b("  </h2>"),i.b("\n"+n),i.b('  <h2 class="bell-title notifications-title hide-phone bell-title-dummy">Your Messages</h2>'),i.b("\n"+n),i.b('  <div class="activity-container js-inbox-container capped">'),i.b("\n"+n),i.b('    <ul class="js-inbox-list"></ul>'),i.b("\n"+n),i.b('    <a href="'),i.b(i.v(i.f("indexUrl",e,t,0))),i.b('" class="js-show-all list-load-more">See all messages</a>'),i.b("\n"+n),i.b('    <div class="js-spin loading-spinner cfix"></div>'),i.b("\n"+n),i.b("  </div>"),i.b("\n"+n),i.b("</div>"),i.b("\n"),i.fl()},partials:{},subs:{}},"",e);return t.template=n,t}),define("require/hgn!templates/inbox/dialog/empty",["hogan"],function(e){function t(){return n.render.apply(n,arguments)}var n=new e.Template({code:function(e,t,n){var i=this;return i.b(n=n||""),i.b('<div class="inbox-empty">No messages in your inbox.</div>'),i.b("\n"),i.fl()},partials:{},subs:{}},"",e);return t.template=n,t}),define("require/hgn!templates/inbox/list/message",["hogan"],function(e){function t(){return n.render.apply(n,arguments)}var n=new e.Template({code:function(e,t,n){var i=this;return i.b(n=n||""),i.b('<li class="inbox-list-item preview-item'),i.s(i.f("unread",e,t,1),e,t,0,50,57,"{{ }}")&&(i.rs(e,t,function(e,t,n){n.b(" unread")}),e.pop()),i.b(' js-inbox-list-item" data-id="'),i.b(i.v(i.f("id",e,t,0))),i.b('">'),i.b("\n"+n),i.b('  <div class="form-item form-item-checkbox indicator checkbox">'),i.b("\n"+n),i.b('    <input type="checkbox" id="preview-'),i.b(i.v(i.f("id",e,t,0))),i.b('">'),i.b("\n"+n),i.b('    <label class="form-label" for="preview-'),i.b(i.v(i.f("id",e,t,0))),i.b('">&nbsp;</label>'),i.b("\n"+n),i.b("  </div>"),i.b("\n"+n),i.b('  <div class="indicator unread-indicator"></div>'),i.b("\n"+n),i.b('  <div class="timestamp">'),i.b(i.v(i.f("timestamp",e,t,0))),i.b("</div>"),i.b("\n"+n),i.b('  <div class="info">'),i.b("\n"+n),i.s(i.f("isGroup",e,t,1),e,t,0,425,737,"{{ }}")&&(i.rs(e,t,function(e,t,i){i.b('      <div class="inbox-image multiple-owners-grid">'),i.b("\n"+n),i.s(i.f("recipients",e,t,1),e,t,0,502,543,"{{ }}")&&(i.rs(e,t,function(e,t,i){i.b('          <img src="'),i.b(i.v(i.f("image",e,t,0))),i.b('">'),i.b("\n"+n)}),e.pop()),i.b("      </div>"),i.b("\n"+n),i.b('      <div class="user text-ellipsis">'),i.b("\n"+n),i.b("        "),i.b(i.v(i.f("byLine",e,t,0))),i.b("\n"+n),i.b('        <span class="js-unread-count'),i.s(i.f("unread",e,t,1),e,t,1,0,0,"")||i.b(" hide"),i.b('">('),i.b(i.v(i.f("unreadCount",e,t,0))),i.b(")</span>"),i.b("\n"+n),i.b("      </div>"),i.b("\n"+n)}),e.pop()),i.b("\n"+n),i.s(i.f("isGroup",e,t,1),e,t,1,0,0,"")||i.s(i.d("recipients.0",e,t,1),e,t,0,791,987,"{{ }}")&&(i.rs(e,t,function(e,t,i){i.b('        <img src="'),i.b(i.v(i.f("image",e,t,0))),i.b('" class="inbox-image">'),i.b("\n"+n),i.b('        <div class="user text-ellipsis">'),i.b(i.v(i.f("byLine",e,t,0))),i.b(' <span class="js-unread-count'),i.s(i.f("unread",e,t,1),e,t,1,0,0,"")||i.b(" hide"),i.b('">('),i.b(i.v(i.f("unreadCount",e,t,0))),i.b(")</span></div>"),i.b("\n"+n)}),e.pop()),i.b('    <div class="message">'),i.b(i.v(i.f("message",e,t,0))),i.b("</div>"),i.b("\n"+n),i.b("  </div>"),i.b("\n"+n),i.b("</li>"),i.b("\n"),i.fl()},partials:{},subs:{}},"",e);return t.template=n,t}),define("be/trait/inboxNav",["jquery","moment","nbd/util/extend","be/spinner","inbox/Model/Message","hgn!templates/html","hgn!templates/inbox/dialog/main","hgn!templates/inbox/dialog/empty","hgn!templates/inbox/list/message"],function(e,t,n,i,s,o,r,a,l){"use strict";var u="/tmpbox",b=u+"/compose";return{mustache:o,templateData:function(){var e=r({indexUrl:u,composeUrl:b});return{title:"Inbox",classes:["notifications","inbox","timeline-container"],html:e}},rendered:function(){this._super(),this.$content=this.$view.find(".js-inbox-container"),this.$list=this.$view.find(".js-inbox-list"),this.$showAll=this.$view.find(".js-show-all"),this.spinner=i.init(this.$view).hide(),this._bindEvents()},_bindEvents:function(){this.$list.on("click","li",function(){var t=e(this).data("id");window.location.href=u+"/"+t})},_renderMessage:function(e){var i=e.data();return l(n(i,{isGroup:i.recipients.length>1,timestamp:t.unix(i.last_message_on).fromNow()}))},loading:function(){this.spinner&&this.spinner.show()},loaded:function(){this.spinner&&this.spinner.hide()},add:function(e){e.forEach(function(e){var t=new s(e);this.$list.append(this._renderMessage(t))}.bind(this))},reset:function(){this.$empty&&(this.$empty.remove(),this.$empty=null),this.$list.empty()},empty:function(){this.$empty=this.$empty||e(a()),this.$showAll.before(this.$empty)}}}),define("be/View/Dialog/Menu/InboxNav",["nbd/util/extend","be/View/Dialog/Menu","be/trait/inboxNav"],function(e,t,n){"use strict";var i,s="107",o="10",r="5";return i=t.extend(e({position:function(e){return this._super(e,{my:"left-"+s+" top-"+o,at:"center bottom+"+r,collision:"none"})}},n))}),define("be/View/Dialog/Layover",["jquery","be/View/Dialog"],function(e,t){"use strict";var n=t.extend({destroy:function(){this.hide(),this._super()},template:function(t){return this._super(e.extend({dialogType:"layover",layover:!0,toolbar:!0},t))},rendered:function(){this._super(),this.show()},show:function(){return this.$view?(this.scrollTop=this.scrollTop||e(window).scrollTop(),e("#site-content").hide(),e("html").addClass("overflow-hidden"),this.$view.show(),this._super()):void 0},hide:function(){return this.$view?(e("#site-content").show(),e("html").removeClass("overflow-hidden"),window.scrollTo(0,this.scrollTop),delete this.scrollTop,this.$view.hide(),this._super()):void 0}});return n}),define("be/View/Dialog/Layover/InboxNav",["be/View/Dialog/Layover","be/trait/inboxNav"],function(e,t){"use strict";var n=e.extend(t);return n}),define("inbox/lib/loader",["lib/xhr"],function(e){"use strict";function t(e){return function(t){var n={};if(!t)throw new Error("Response is not valid");return n=t[e]}}var n="/v2/inbox",i=n+"/threads",s="/messages",o="/v2/report/spam/thread",r={threads:function(t,n){return e({url:i,type:"GET",data:{folder:t,thread_id:n&&n.thread,message_id:n&&n.message}})},pollThreads:function(t,n,s){return e({url:i,type:"GET",data:{folder:t,thread_id:n,message_id:s,is_poll:1}})},thread:function(n){return e({url:i+"/"+n,type:"GET"}).then(t("thread"))},threadMessages:function(t){return e({url:i+"/"+t+s,type:"GET"})},pollMessages:function(t,n){return e({url:i+"/"+t+s,type:"GET",data:{message_id:n,is_poll:1}})},markRead:function(t){return e({url:i+"/"+t,type:"PATCH",data:{is_read:1}})},moveTo:function(t,n){return e({url:i+"/"+t,type:"PATCH",data:{folder:n}})},markSpam:function(t){return e({url:o+"/"+t,type:"POST"})},deleteThreadForever:function(t){return e({url:i+"/"+t,type:"DELETE"})},replyToThread:function(n,o){return e({url:i+"/"+n+s,type:"POST",data:{message:o}}).then(t("message"))},markMessageRead:function(t,n){return e({url:i+"/"+t+s+"/"+n,type:"PATCH",data:{is_read:1}})},createNewThread:function(n,s){return e({url:i,type:"POST",data:{recipients:n,message:s}}).then(t("thread"))}};return r}),define("be/Controller/Dialog/InboxNav",["nbd/trait/pubsub","be/Controller/Dialog/Roulette","be/View/Dialog/Menu/InboxNav","be/View/Dialog/Layover/InboxNav","inbox/lib/loader"],function(e,t,n,i,s){"use strict";var o=t.extend({_initView:function(){this._super.apply(this,arguments),this._view&&this.listenTo(this._view,"show",this._refresh)},_refresh:function(){this._view.loading(),s.threads().then(function(e){e=e.threads||[],this._view.loaded(),this._view.reset(),e.length?this._view.add(e):this._view.empty()}.bind(this),function(){this._view.loaded(),this._view.reset(),this._view.empty()}.bind(this))}},{VIEW_CLASS:{phone:i,tablet:n,desktop:n}}).mixin(e);return o}),define("be/inboxNav",["jquery","has","nbd/util/deparam","lib/xhr","be/Controller/Dialog/InboxNav"],function(e,t,n,i,s){"use strict";var o,r="/v2/notifications/count",a="inbox-v1";return o={init:function(n){var i=e(".js-email-menu",n);i.length&&(this.$message=i,this._dialog=new s,this._dialog.setContext(i),t("localstorage")&&this.update(window.sessionStorage.getItem("message-notifications")||0),this._sync())},update:function(e){var t=0===+e;this.$message.toggleClass("unread",!t).find(".notifications-count").toggleClass("hide",t).text(e),this._dialog.block=t},_sync:function(){return i({url:r,type:"get",data:{action_set:a}}).then(function(e){return t("localstorage")&&window.sessionStorage.setItem("message-notifications",e.count),e.count}).then(o.update.bind(o))}}});